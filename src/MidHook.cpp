#include "safetyhook/Factory.hpp"
#include "safetyhook/InlineHook.hpp"

#include "safetyhook/MidHook.hpp"

namespace safetyhook {

const uint8_t asm_data[] = {0x54, 0x55, 0x50, 0x53, 0x51, 0x52, 0x56, 0x57, 0x41, 0x50, 0x41, 0x51, 0x41, 0x52, 0x41,
    0x53, 0x41, 0x54, 0x41, 0x55, 0x41, 0x56, 0x41, 0x57, 0x9C, 0x48, 0x8D, 0x0C, 0x24, 0x48, 0x83, 0xEC, 0x28, 0x48,
    0xF7, 0xC4, 0x08, 0x00, 0x00, 0x00, 0x0F, 0x84, 0x10, 0x00, 0x00, 0x00, 0x48, 0x83, 0xEC, 0x08, 0x48, 0xC7, 0xC3,
    0x30, 0x00, 0x00, 0x00, 0xE9, 0x07, 0x00, 0x00, 0x00, 0x48, 0xC7, 0xC3, 0x28, 0x00, 0x00, 0x00, 0xFF, 0x15, 0x22,
    0x00, 0x00, 0x00, 0x48, 0x01, 0xDC, 0x9D, 0x41, 0x5F, 0x41, 0x5E, 0x41, 0x5D, 0x41, 0x5C, 0x41, 0x5B, 0x41, 0x5A,
    0x41, 0x59, 0x41, 0x58, 0x5F, 0x5E, 0x5A, 0x59, 0x5B, 0x58, 0x5D, 0x5C, 0xFF, 0x25, 0x08, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

MidHook::MidHook(std::shared_ptr<Factory> factory, uintptr_t target, MidHookFn destination)
    : m_factory{std::move(factory)}, m_target{target}, m_destination{destination} {
    constexpr auto x = sizeof(Context);

    m_stub = m_factory->allocate(sizeof(asm_data));

    std::copy_n(asm_data, sizeof(asm_data), (uint8_t*)m_stub);

    *(MidHookFn*)(m_stub + sizeof(asm_data) - 16) = destination;

    m_hook = m_factory->m_builder->create_inline((void*)target, (void*)m_stub);

    if (m_hook == nullptr) {
        m_factory->free(m_stub, sizeof(asm_data));
        m_stub = 0;
        return;
    }

    *(uintptr_t*)(m_stub + sizeof(asm_data) - 8) = m_hook->trampoline();
}

MidHook::~MidHook() {
    if (m_stub != 0) {
        m_factory->free(m_stub, sizeof(asm_data));
    }

    m_hook.reset();
}

} // namespace safetyhook